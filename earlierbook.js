(()=>{"use strict";const K="ar_nc_v9";const G=()=>{try{return JSON.parse(localStorage.getItem(K)||"{}")}catch{return{}}},P=o=>localStorage.setItem(K,JSON.stringify(o));let st=Object.assign({r:!1,b:null,z:"both"},G());P(st);const S=ms=>new Promise(r=>setTimeout(r,ms)),R=(a,b)=>Math.floor(Math.random()*(b-a+1))+a,Q=(s,r=document)=>r.querySelector(s),A=(s,r=document)=>Array.from(r.querySelectorAll(s)),BN=new Set(["www.expo2025.or.jp"]),BB=t=>{if(!t)return!1;const e=t.closest?.("a[href]")??(t.tagName==="A"?t:null);if(!e)return!1;try{return BN.has(new URL(e.href,location.href).hostname)}catch{return console.warn("[EarlierBook] Failed to inspect navigation target"),!1}};const H=h=>({10:600,11:660,12:720,17:1020}[h]??null),hH=m=>({600:10,660:11,720:12,1020:17}[m]??"");const D=e=>!e||e.disabled||(e.getAttribute("aria-disabled")||"").toLowerCase()=="true"||/\bdisabled\b/i.test(e.className||"")||e.getAttribute("data-disabled")=="true"||(()=>{try{return getComputedStyle(e).pointerEvents=="none"}catch{return!1}})();async function W({sel,txt,t=1e4,i=200}={}){const s=Date.now();for(;;){if(Date.now()-s>t)return null;if(sel){const e=Q(sel);if(e&&!D(e))return e}if(txt){const e=A("button,a,[role=button]").find(b=>{const t=(b.textContent||b.getAttribute("aria-label")||"").trim();return txt.test(t)&&!D(b)});if(e)return e}await S(i)}}async function KC(e){if(!e||D(e))return!1;if(BB(e))return console.warn("[EarlierBook] Skipping blocked navigation to Expo 2025 homepage"),!1;await S(500+R(0,1000));e.click?.();return!0}const SEL_TOJ='div.style_buy__2YcAY:nth-of-type(1) > ul.buttons:nth-of-type(1) > li:nth-of-type(1) > a.basic-btn.type3:nth-of-type(1)',SEL_XA='div.ReactModal__Content.ReactModal__Content--after-open:nth-of-type(1) > div.style_modal__ZpsOM:nth-of-type(1) > a.style_close__lYrCO:nth-of-type(1)',SEL_SUCC='h2#reservation_modal_title',SEL_FAIL='h2#reservation_fail_modal_title';async function closeFailThenReload(){let el=Q(SEL_TOJ);if(await KC(el)){await S(120+R(60,140));location.reload();return}el=Q(SEL_XA);if(el&&(await KC(el)||await KC(el.querySelector("img")))){await S(120+R(60,140));location.reload();return}el=Q('button[aria-label="閉じる"],a[aria-label="閉じる"],[data-modal-close],.modal-close');if(await KC(el)){await S(100);location.reload();return}const img=Q('img[src*="close.svg"],[style*="close.svg"],use[href*="close.svg"],image[href*="close.svg"]');if(img){const p=img.closest("a,button,[role=button]")||img;if(await KC(p)){await S(100);location.reload();return}}el=A("[class*='close'],[class*='Close'],[class*='CLOSE']").find(x=>!D(x));if(await KC(el)){await S(100);location.reload();return}try{document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",bubbles:!0}))}catch{}await S(60);location.reload()}const ui=(()=>{const w=document.createElement("div");Object.assign(w.style,{position:"fixed",bottom:"20px",right:"20px",zIndex:999999,background:"rgba(255,255,255,.95)",padding:"10px 12px",borderRadius:"12px",boxShadow:"0 2px 10px rgba(0,0,0,.2)",fontFamily:"-apple-system,system-ui,Segoe UI,Roboto,sans-serif",width:"300px"});const row=m=>{const d=document.createElement("div");Object.assign(d.style,{display:"flex",gap:"8px",alignItems:"center",marginBottom:(m??8)+"px"});return d};const h=row();const t=document.createElement("div");t.textContent="予約";t.style.fontWeight="bold";const g=document.createElement("input");g.type="checkbox";g.checked=!!st.r;h.appendChild(t);h.appendChild(g);const r1=row();const l1=document.createElement("label");l1.textContent="基準時刻";l1.style.width="64px";l1.style.fontSize="12px";const hs=document.createElement("select");hs.style.flex="1";[["","未設定"],["10","10時"],["11","11時"],["12","12時"],["17","17時"]].forEach(([v,t])=>{const o=document.createElement("option");o.value=v;o.textContent=t;hs.appendChild(o)});if(st.b!=null){const hv=hH(st.b)+"";if(hv)hs.value=hv}const r2=row();const l2=document.createElement("label");l2.textContent="ゲート";l2.style.width="64px";l2.style.fontSize="12px";const zs=document.createElement("select");zs.style.flex="1";[["both","両方"],["east","東ゲート"],["west","西ゲート"]].forEach(([v,t])=>{const o=document.createElement("option");o.value=v;o.textContent=t;zs.appendChild(o)});zs.value=st.z;const s=document.createElement("div");s.style.fontSize="12px";s.textContent=st.r?"稼働中":"停止中";w.appendChild(h);r1.appendChild(l1);r1.appendChild(hs);w.appendChild(r1);r2.appendChild(l2);r2.appendChild(zs);w.appendChild(r2);w.appendChild(s);document.body.appendChild(w);function read(){const v=hs.value;const b=v?H(+v):null;if(b==null){set("基準時刻を選択してください");return null}return{b,z:zs.value}}g.addEventListener("change",()=>{if(g.checked){const c=read();if(!c){g.checked=!1;return}st.r=!0;st.b=c.b;st.z=c.z;P(st);set(`稼働中（基準 ${hs.value}時）`);run()}else{st.r=!1;P(st);set("停止中");clearTimeout(T)}});[hs,zs].forEach(el=>el.addEventListener("change",()=>{if(el===hs&&hs.value===""){st.b=null;P(st);if(st.r)set("基準時刻を選択してください");return}const b=H(+hs.value);if(b!=null)st.b=b;st.z=zs.value;P(st);if(st.r)set(`稼働中（基準 ${hs.value}時）`)}));function set(x){s.textContent=x}function uncheck(){try{g.checked=!1;g.dispatchEvent(new Event("input",{bubbles:!0}));g.dispatchEvent(new Event("change",{bubbles:!0}))}catch{}set("停止中")}return{set,hs,uncheck}})();let T=null;function sched(){if(!st.r)return;const d=R(3e3,8e3);ui.set(`空き無し/失敗→${Math.round(d/1e3)}秒後再読込`);clearTimeout(T);T=setTimeout(()=>{if(st.r)location.reload()},d)}function stopOK(){try{clearTimeout(T)}catch{}st.r=!1;st.b=null;P(st);try{ui.hs.value=""}catch{}ui.uncheck();ui.set("来場日時が設定されました。停止＆基準時刻リセット。")}async function zone(p){if(p!=="east"&&p!=="west")return!0;const want=p==="east"?"東":"西";const b=A("button,a,div[role=button]").find(e=>{const t=(e.textContent||e.getAttribute("aria-label")||"").normalize("NFKC");return t.includes(want)&&!D(e)});if(b){await KC(b);await S(200+R(60,180))}return!!b}function t2m(s){const m=s.match(/(\d{1,2})\s*[:：]\s*(\d{2})/);if(!m)return null;const h=+m[1],mm=+m[2];if(isNaN(h)||isNaN(mm))return null;return h*60+mm}function slots(){return A("button,a,div[role=button]").map(el=>{const t=(el.textContent||"").trim(),m=t2m(t);return m==null?null:{el,mins:m,text:t}}).filter(Boolean)}function pick(ss,b){const c=ss.filter(x=>!D(x.el)&&x.mins<b).sort((a,b)=>a.mins-b.mins);return c[0]||null}async function waitSlotsReady(t=6e3){const t0=Date.now();for(;;){const ok=A("button,a,div[role=button]").some(el=>/(\d{1,2})\s*[:：]\s*(\d{2})/.test((el.textContent||"")));if(ok)return!0;if(Date.now()-t0>t)return!1;await S(150)}}async function flow(){let b=await W({sel:"button.basic-btn.type2.style_full__ptzZq",txt:/来場日時を設定する/,t:8e3});if(!b)return"retry";await KC(b);b=await W({sel:"button.style_next_button__N_pbs",txt:/来場日時を変更する/,t:4e3,i:150});if(b)await KC(b);await W({txt:/確認|来場日時|交通|手段/,t:5e3,i:150});const t0=Date.now();for(;;){if(Q(SEL_SUCC)){stopOK();return"success"}if(Q(SEL_FAIL)){await closeFailThenReload();return"force"}if(Date.now()-t0>12e3)break;await S(120)}return"retry"}async function scan(){const order=st.z==="both"?(Math.random()<.5?["east","west"]:["west","east"]):[st.z];for(const z of order){if(!st.r)return!1;await zone(z);await waitSlotsReady();await S(120+R(40,140));const s=slots(),p=pick(s,st.b);if(!p)continue;ui.set(`発見：${p.text}（${z==="east"?"東":"西"}）→変更`);await KC(p.el);const r=await flow();if(r==="success")return!0;if(r==="force")return!1;await S(180+R(40,140))}return!1}async function run(){const t0=Date.now();while(document.readyState!=="complete"&&Date.now()-t0<3e3)await S(80);if(Q(SEL_SUCC)){stopOK();return}if(Q(SEL_FAIL)){await closeFailThenReload();return}if(!st.r)return;if(st.b==null){ui.set("基準時刻を選択してください");return}await waitSlotsReady();const ok=await scan();if(!st.r)return;if(ok){return}sched()}if(st.r)run();window.addEventListener("beforeunload",()=>clearTimeout(T));})();
